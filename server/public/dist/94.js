"use strict";(self.webpackChunksleact_ts_front=self.webpackChunksleact_ts_front||[]).push([[94],{3094:function(e,t,a){a.r(t),a.d(t,{default:function(){return x}});var n=a(3564),r=a(7294),l=a(6182),s=a.n(l),o=a(5977),c=a(2545),i=a(2309),u=a(8678),m=a(9669),d=a.n(m),f=a(8667),g=a(8100),p=a(4593),h=a(2951),k=a(9249),v=a(9732),w=a(6482);const T=(0,w.Z)("div",{target:"egh2dki1"})({name:"1a0r0eh",styles:"display:flex;flex-wrap:wrap;height:calc(100vh - 38px);flex-flow:column;position:relative"}),b=(0,w.Z)("header",{target:"egh2dki0"})({name:"1c17pcy",styles:"height:64px;display:flex;width:100%;--saf-0:rgba(var(--sk_foreground_low, 29, 28, 29), 0.13);box-shadow:0 1px 0 var(--saf-0);padding:20px 16px 20px 20px;font-weight:bold;align-items:center;& img{margin-right:5px;}"});var x=()=>{const{workspace:e,id:t}=(0,o.UO)(),{data:a,error:l}=(0,g.ZP)(`/api/workspaces/${e}/users/${t}`,n.Z),{data:m}=(0,g.ZP)("/api/users",n.Z),[w,x,Z]=(0,u.Z)(""),{data:E,mutate:S,setSize:C}=(0,p.ZP)((a=>`/api/workspaces/${e}/dms/${t}/chats?perPage=20&page=${a+1}`),n.Z),[$]=(0,h.Z)(e),D=(0,r.useRef)(null),[_,y]=(0,r.useState)(!1),B=0===E?.[0]?.length||E&&E[E.length-1]?.length<20||!1,R=(0,r.useCallback)((n=>{if(n.preventDefault(),console.log("submit"),console.log("chat",w),w?.trim()&&E){const n=w;S((e=>(e?.[0].unshift({id:(E[0][0]?.id||0)+1,content:n,SenderId:m.id,Sender:m,ReceiverId:a.id,Receiver:a,createdAt:new Date}),e)),!1).then((()=>{Z(""),D.current?.scrollToBottom()})),d().post(`/api/workspaces/${e}/dms/${t}/chats`,{content:w}).then((()=>{S()})).catch(console.error)}}),[w,E,m,a,e,t]),I=(0,r.useCallback)((e=>{e.SenderId===Number(t)&&m.id!==Number(t)&&S((t=>(t?.[0].unshift(e),t)),!1).then((()=>{D.current&&(D.current.getScrollHeight()<D.current.getClientHeight()+D.current.getScrollTop()+150?(console.log("scrollToBottom!",D.current?.getValues()),setTimeout((()=>{D.current?.scrollToBottom()}),100)):k.Am.success("새 메시지가 도착했습니다.",{onClick(){D.current?.scrollToBottom()},closeOnClick:!0}))}))}),[t,m,S]);(0,r.useEffect)((()=>($?.on("dm",I),()=>{$?.off("dm",I)})),[$,I]),(0,r.useEffect)((()=>{1===E?.length&&D.current?.scrollToBottom()}),[E]);const P=(0,r.useCallback)((a=>{a.preventDefault(),console.log(a);const n=new FormData;if(a.dataTransfer.items){for(let e=0;e<a.dataTransfer.items.length;e++)if(console.log(a.dataTransfer.items[e]),"file"===a.dataTransfer.items[e].kind){const t=a.dataTransfer.items[e].getAsFile();console.log("... file["+e+"].name = "+t.name),n.append("image",t)}}else for(let e=0;e<a.dataTransfer.files.length;e++)console.log("... file["+e+"].name = "+a.dataTransfer.files[e].name),n.append("image",a.dataTransfer.files[e]);d().post(`/api/workspaces/${e}/dms/${t}/images`,n).then((()=>{y(!1),localStorage.setItem(`${e}-${t}`,(new Date).getTime().toString()),S()}))}),[e,t,S]),A=(0,r.useCallback)((e=>{e.preventDefault(),console.log(e),y(!0)}),[]);if(!a||!m)return null;if(l)return r.createElement("div",null,l?.response.data);if(void 0===E)return r.createElement("div",null,"DM 메시지 불러오는중 ...");if(!a||!m)return null;const F=(0,f.Z)(E?[].concat(...E).reverse():[]);return r.createElement(T,{onDrop:P,onDragOver:A},r.createElement(b,null,r.createElement("img",{src:s().url(a.email,{s:"24px",d:"retro"}),alt:a.nickname}),r.createElement("span",null,a.nickname)),r.createElement(c.Z,{chatSections:F,scrollbarRef:D,setSize:C,isReachingEnd:B}),r.createElement(i.Z,{chat:w,onChangeChat:x,onSubmitForm:R}),_&&r.createElement(v.KW,null,"업로드"))}}}]);